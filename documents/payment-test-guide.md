# راهنمای تست سیستم پرداخت زرین‌پال

## 🧪 مراحل تست کامل سیستم پرداخت

### پیش‌نیازها

✅ سرور Laravel در حال اجرا (`http://localhost:8000`)
✅ Frontend در حال اجرا (`http://localhost:5174`)
✅ یک وام با وضعیت `approved` در سیستم
✅ کاربر لاگین شده

---

## 📝 مراحل تست

### مرحله 1: ایجاد وام

1. با کاربر لاگین شوید
2. به `/loan-request` بروید
3. یک وام ایجاد کنید:
   - مبلغ: 10000000 تومان
   - مدت: 12 ماه
4. با admin لاگین شوید
5. به `/loan-approval` بروید
6. وام را تایید کنید

### مرحله 2: رفتن به صفحه پرداخت

1. به حساب کاربری برگردید
2. به صفحه جزئیات وام بروید: `/loan-details/{id}`
3. یا مستقیماً به: `/loan-payment/{id}` بروید

### مرحله 3: پرداخت قسط

1. یک قسط را انتخاب کنید
2. روی دکمه "پرداخت" کلیک کنید
3. به درگاه منتقل می‌شوید

### مرحله 4: پرداخت در Sandbox

#### اطلاعات کارت تست:
```
شماره کارت: 6037991234567890
CVV2: 123
تاریخ انقضاء: 12/25
کلمه عبور: 1234
```

### مرحله 5: بررسی نتیجه

بعد از پرداخت موفق، به صفحه موفقیت منتقل می‌شوید.

بررسی‌ها:
- ✅ مبلغ را بررسی کنید
- ✅ شناسه پرداخت را بررسی کنید
- ✅ بازگشت به صفحه پرداخت - وضعیت باید به‌روزرسانی شده باشد
- ✅ بررسی باقیمانده وام

---

## 🔍 بررسی دیتابیس

### بررسی با Tinker

```bash
php artisan tinker
```

```php
// بررسی پرداخت‌ها
LoanPayment::latest()->first();

// بررسی schedule‌ها
LoanSchedule::where('status', 'paid')->get();

// بررسی وام‌ها
Loan::with('schedules')->find(15);
```

---

## 📊 جدول وظایف

| مرحله | شرح | وضعیت |
|-------|-----|-------|
| 1 | ایجاد وام | ⏳ |
| 2 | تایید وام | ⏳ |
| 3 | شروع پرداخت | ⏳ |
| 4 | پرداخت در sandbox | ⏳ |
| 5 | بررسی نتیجه | ⏳ |

---

## ⚠️ نکات مهم

1. **هر پرداخت یک authority منحصر به فرد دارد**
2. **پرداخت یک‌باری است** - اگر قبلاً پرداخت شد، کد 101 می‌آید
3. **Sandbox محدودیت دارد** - اگر error "Too many attempts" دیدید، 5 دقیقه صبر کنید
4. **Cache را بعد از تغییرات پاک کنید**: `php artisan optimize:clear`

---

## 🐛 مشکلات رایج

### Problem: "Too many attempts"

**راه‌حل:** 5 دقیقه صبر کنید و دوباره تلاش کنید

### Problem: وضعیت به‌روزرسانی نمی‌شود

**راه‌حل:**
1. لاگ‌ها را بررسی کنید
2. مطمئن شوید schedule وجود دارد
3. سرور را restart کنید

### Problem: Redirect به پورت اشتباه

**راه‌حل:**
```bash
php artisan config:clear
# .env را بررسی کنید:
FRONTEND_URL=http://localhost:5174
```

---

## ✅ Checklist نهایی

- [ ] وام ایجاد و تایید شد
- [ ] پرداخت با موفقیت انجام شد
- [ ] به صفحه success redirect شد
- [ ] وضعیت schedule به‌روزرسانی شد
- [ ] باقی‌مانده وام به‌روزرسانی شد
- [ ] در صورت تمام شدن، وضعیت وام به `paid` تغییر کرد

---

**آخرین بروزرسانی**: 26 اکتبر 2025

